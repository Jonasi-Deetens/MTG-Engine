# src/axis3/state/game_state.py

from __future__ import annotations

from dataclasses import dataclass, field
from enum import Enum, auto
from typing import Dict, List, Optional

from axis3.state.objects import RuntimeObject, RuntimeObjectId
from axis3.rules.events import EventBus
from axis3.engine.stack.stack import Stack   # FIXED: import Stack properly


class Phase(Enum):
    BEGINNING = auto()
    PRECOMBAT_MAIN = auto()
    COMBAT = auto()
    POSTCOMBAT_MAIN = auto()
    ENDING = auto()


class Step(Enum):
    UNTAP = auto()
    UPKEEP = auto()
    DRAW = auto()
    BEGIN_COMBAT = auto()
    DECLARE_ATTACKERS = auto()
    DECLARE_BLOCKERS = auto()
    COMBAT_DAMAGE = auto()
    END_COMBAT = auto()
    END_STEP = auto()
    CLEANUP = auto()


@dataclass
class PlayerState:
    id: int
    life: int = 20

    library: List[RuntimeObjectId] = field(default_factory=list)
    hand: List[RuntimeObjectId] = field(default_factory=list)
    battlefield: List[RuntimeObjectId] = field(default_factory=list)
    graveyard: List[RuntimeObjectId] = field(default_factory=list)
    exile: List[RuntimeObjectId] = field(default_factory=list)
    command: List[RuntimeObjectId] = field(default_factory=list)

    mana_pool: Dict[str, int] = field(default_factory=dict)
    max_hand_size: int = 7


@dataclass
class TurnState:
    active_player: int = 0
    priority_player: int = 0
    phase: Phase = Phase.BEGINNING
    step: Step = Step.UNTAP
    turn_number: int = 1

    stack_empty_since_last_priority: bool = True


@dataclass
class GameState:
    players: List[PlayerState]
    objects: Dict[RuntimeObjectId, RuntimeObject]

    turn: TurnState = field(default_factory=TurnState)

    stack: Stack = field(default_factory=Stack)
    event_bus: EventBus = field(default_factory=EventBus)

    replacement_effects: List[object] = field(default_factory=list)

    # FIXED: forward reference avoids circular import
    continuous_effects: List["RuntimeContinuousEffect"] = field(default_factory=list)
    global_restrictions: list = field(default_factory=list)